<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ Viral Content Creator Pro</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff
        }

        .container {
            max-width: 1000px;
            margin: 0 auto
        }

        .header {
            text-align: center;
            margin-bottom: 25px
        }

        .header h1 {
            font-size: 28px;
            background: linear-gradient(90deg, #00b894, #00cec9, #74b9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px
        }

        .badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 11px;
            background: linear-gradient(90deg, #00b894, #00cec9);
            margin-bottom: 10px;
            font-weight: 600
        }

        .panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px
        }

        .cat-btn {
            padding: 14px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 12px
        }

        .cat-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px)
        }

        .cat-btn.active {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.15);
            box-shadow: 0 0 20px rgba(0, 184, 148, 0.3)
        }

        .cat-btn .icon {
            font-size: 26px;
            display: block;
            margin-bottom: 6px
        }

        .format-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px
        }

        .format-btn {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 13px
        }

        .format-btn:hover {
            background: rgba(255, 255, 255, 0.1)
        }

        .format-btn.active {
            border-color: #6c5ce7;
            background: rgba(108, 92, 231, 0.2)
        }

        .format-btn .icon {
            font-size: 28px;
            display: block;
            margin-bottom: 5px
        }

        .input-group {
            margin-bottom: 12px
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.8
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 13px
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3)
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4)
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none
        }

        .step {
            padding: 10px 14px;
            margin: 6px 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid #333;
            display: flex;
            align-items: center;
            font-size: 13px;
            transition: all 0.3s
        }

        .step.active {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.1)
        }

        .step.done {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.1)
        }

        .step-icon {
            font-size: 18px;
            margin-right: 10px
        }

        .output-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 16px;
            margin-top: 15px
        }

        .config-toggle {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            margin-bottom: 12px
        }

        .config-panel {
            display: none;
            margin-bottom: 15px
        }

        .config-panel.show {
            display: block
        }

        .content-section {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05)
        }

        .content-section h4 {
            color: #00b894;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .question-box {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.15), rgba(0, 206, 201, 0.1));
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
            border: 1px solid rgba(0, 184, 148, 0.2)
        }

        .audio-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px
        }

        .audio-btn {
            padding: 12px 18px;
            background: linear-gradient(135deg, #00b894, #00a884);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s
        }

        .audio-btn:hover {
            transform: translateY(-1px)
        }

        .audio-btn.stop {
            background: linear-gradient(135deg, #e74c3c, #c0392b)
        }

        .audio-btn.download {
            background: linear-gradient(135deg, #6c5ce7, #5b4cdb)
        }

        .audio-btn:disabled {
            opacity: 0.5
        }

        .script-box {
            background: #0a0a0f;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.9;
            color: #00ff88;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(0, 255, 136, 0.2)
        }

        .caption-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.7;
            color: #fff;
            white-space: pre-wrap
        }

        .copy-btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, #6c5ce7, #5b4cdb);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            margin-right: 8px;
            font-weight: 600
        }

        .hashtags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px
        }

        .hashtag {
            background: rgba(0, 184, 148, 0.2);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid rgba(0, 184, 148, 0.3)
        }

        /* Media Preview */
        .media-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px
        }

        .media-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            text-align: center
        }

        .media-card h5 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #00b894
        }

        .media-card canvas {
            width: 100%;
            max-width: 280px;
            border-radius: 10px
        }

        .media-card video {
            width: 100%;
            max-width: 280px;
            border-radius: 10px;
            background: #000
        }

        /* Carousel Styles */
        .carousel-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 15px
        }

        .carousel-slide {
            background: #16213e;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s
        }

        .carousel-slide:hover {
            border-color: #00b894
        }

        .carousel-slide.active {
            border-color: #00b894;
            box-shadow: 0 0 15px rgba(0, 184, 148, 0.3)
        }

        .carousel-slide canvas {
            width: 100%;
            display: block
        }

        .carousel-slide-label {
            padding: 8px;
            text-align: center;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.3)
        }

        .carousel-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-right: 8px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* Speed slider */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px
        }

        .speed-control label {
            font-size: 11px;
            opacity: 0.7
        }

        .speed-control input {
            flex: 1
        }

        @media(max-width:600px) {
            .category-grid {
                grid-template-columns: repeat(2, 1fr)
            }

            .format-toggle {
                flex-direction: column
            }

            .carousel-preview {
                grid-template-columns: repeat(2, 1fr)
            }

            .media-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <span class="badge">ü§ñ PRO AUTOMATION 2025</span>
            <h1>üé¨ Viral Content Creator</h1>
            <p style="opacity:0.6;font-size:13px">Soru + Doƒüal Ses + Profesyonel G√∂rsel = Viral ƒ∞√ßerik</p>
        </div>

        <div class="panel">
            <h4 style="margin-bottom:12px;font-size:14px">üìÇ Kategori Se√ß</h4>
            <div class="category-grid">
                <button class="cat-btn active" data-cat="kuafor"><span class="icon">üíá</span>Kuaf√∂r</button>
                <button class="cat-btn" data-cat="ai"><span class="icon">ü§ñ</span>Yapay Zeka</button>
                <button class="cat-btn" data-cat="bilim"><span class="icon">üî¨</span>Bilim</button>
                <button class="cat-btn" data-cat="fitness"><span class="icon">üí™</span>Fitness</button>
                <button class="cat-btn" data-cat="finans"><span class="icon">üí∞</span>Finans</button>
                <button class="cat-btn" data-cat="yemek"><span class="icon">üç≥</span>Yemek</button>
                <button class="cat-btn" data-cat="sanat"><span class="icon">üé®</span>Sanat</button>
                <button class="cat-btn" data-cat="gelisim"><span class="icon">üßò</span>Geli≈üim</button>
                <button class="cat-btn" data-cat="gizlitarih"><span class="icon">üóø</span>Gizli Tarih</button>
            </div>
        </div>

        <div class="panel">
            <h4 style="margin-bottom:12px;font-size:14px">üéØ Format Se√ß</h4>
            <div class="format-toggle">
                <button class="format-btn active" data-format="reels"><span class="icon">üé¨</span>Reels / Story</button>
                <button class="format-btn" data-format="carousel"><span class="icon">üìë</span>Carousel Post</button>
            </div>
        </div>

        <div class="panel">
            <button class="config-toggle" onclick="toggleConfig()">‚öôÔ∏è API Ayarlarƒ±</button>
            <div class="config-panel" id="configPanel">
                <div class="input-group">
                    <label>üîë <a href="https://huggingface.co/settings/tokens" target="_blank"
                            style="color:#00b894">HuggingFace Token</a></label>
                    <input type="password" id="tokenInput" placeholder="hf_xxxxxxxxxxxxx">
                </div>
                <button onclick="saveToken()"
                    style="padding:8px 15px;background:#00b894;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:12px">üíæ
                    Kaydet</button>
            </div>
            <button class="btn" id="startBtn" onclick="runWorkflow()">üöÄ Vƒ∞RAL ƒ∞√áERƒ∞K OLU≈ûTUR</button>
        </div>

        <div class="panel" id="stepsPanel" style="display:none">
            <div class="step" id="s1"><span class="step-icon">‚ùì</span>Trend Soru Bulunuyor</div>
            <div class="step" id="s2"><span class="step-icon">üéôÔ∏è</span>Seslendirme Yazƒ±lƒ±yor</div>
            <div class="step" id="s3"><span class="step-icon">üñºÔ∏è</span>G√∂rseller Olu≈üturuluyor</div>
            <div class="step" id="s4"><span class="step-icon">üìù</span>Caption & Hashtag</div>
        </div>

        <div class="output-box" id="outputBox" style="display:none">
            <div class="question-box" id="questionBox"></div>

            <!-- Reels Output with Video Preview -->
            <div id="reelsOutput">
                <div class="media-grid">
                    <div class="media-card">
                        <h5>üñºÔ∏è G√∂rsel</h5>
                        <canvas id="finalCanvas" width="540" height="960"></canvas>
                        <div style="margin-top:10px">
                            <button class="audio-btn download" onclick="downloadImage()">üì• ƒ∞ndir</button>
                        </div>
                    </div>
                    <div class="media-card">
                        <h5>üé¨ Video √ñnizleme</h5>
                        <video id="videoPreview" controls style="display:none"></video>
                        <canvas id="videoCanvas" width="540" height="960" style="display:none"></canvas>
                        <div id="videoPlaceholder"
                            style="width:100%;max-width:280px;height:200px;background:rgba(0,0,0,0.5);border-radius:10px;display:flex;align-items:center;justify-content:center;margin:0 auto">
                            <span style="opacity:0.5;font-size:12px">Sesle g√∂rsel birle≈ütirilecek</span>
                        </div>
                        <div style="margin-top:10px">
                            <button class="audio-btn" id="createVideoBtn" onclick="createVideoPreview()">üé¨ Video
                                Olu≈ütur</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carousel Output -->
            <div id="carouselOutput" style="display:none">
                <div class="content-section">
                    <h4>üìë Carousel Slide'larƒ± (7 adet)</h4>
                    <div class="carousel-preview" id="carouselPreview"></div>
                    <div class="carousel-actions">
                        <button class="audio-btn download" onclick="downloadAllSlides()">üì• T√ºm√ºn√º ƒ∞ndir</button>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <h4>üîä Seslendirme</h4>
                <div class="audio-section">
                    <button class="audio-btn" id="playBtn" onclick="speakScript()">‚ñ∂Ô∏è Dinle</button>
                    <button class="audio-btn stop" onclick="stopSpeech()">‚èπÔ∏è Durdur</button>
                </div>
                <div class="speed-control">
                    <label>üê¢ Hƒ±z:</label>
                    <input type="range" id="speedRange" min="0.7" max="1.1" step="0.05" value="0.85">
                    <label>üêá</label>
                </div>
            </div>

            <div class="content-section">
                <h4>üéôÔ∏è Seslendirme Metni</h4>
                <div class="script-box" id="scriptBox"></div>
                <button class="copy-btn" onclick="copyScript()">üìã Metni Kopyala</button>
            </div>

            <div class="content-section">
                <h4>üìù Caption (Cevap ƒ∞√ßerir)</h4>
                <div class="caption-box" id="captionBox"></div>
                <button class="copy-btn" onclick="copyCaption()">üìã Caption Kopyala</button>
            </div>

            <div class="content-section">
                <h4>üè∑Ô∏è Hashtags</h4>
                <div class="hashtags" id="hashtagBox"></div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://router.huggingface.co/v1/chat/completions';

        let selectedCategory = 'kuafor';
        let selectedFormat = 'reels';
        let currentScript = '';
        let currentQuestion = '';
        let currentCaption = '';
        let carouselSlides = [];

        // Category selection
        document.querySelectorAll('.cat-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCategory = btn.dataset.cat;
            };
        });

        // Format selection
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedFormat = btn.dataset.format;
            };
        });

        function toggleConfig() { document.getElementById('configPanel').classList.toggle('show'); }
        function saveToken() { localStorage.setItem('hf_token', document.getElementById('tokenInput').value); alert('‚úÖ Kaydedildi!'); toggleConfig(); }
        function getToken() { return localStorage.getItem('hf_token') || ''; }
        window.onload = () => { if (getToken()) document.getElementById('tokenInput').value = getToken(); }

        function getRandomTopic(topics) {
            return topics[Math.floor(Math.random() * topics.length)];
        }

        const CATEGORIES = {
            kuafor: {
                name: 'Sa√ß Bakƒ±mƒ±', color: '#e84393',
                topics: ['ombre bakƒ±mƒ±', 'balyaj bakƒ±mƒ±', 'boyalƒ± sa√ß', 'sa√ß d√∂k√ºlmesi', 'kƒ±rƒ±k u√ßlar', 'sa√ß uzatma', 'kƒ±vƒ±rcƒ±k sa√ß', 'yaƒülƒ± sa√ß', 'kuru sa√ß', 'renk koruma', 'kƒ±≈ü bakƒ±mƒ±', 'yaz bakƒ±mƒ±', 'keratin'],
                imagePrompt: 'professional hair salon, beautiful healthy shiny hair, modern aesthetic, soft lighting'
            },
            ai: {
                name: 'Yapay Zeka', color: '#0984e3',
                topics: ['ChatGPT', '√ºcretsiz AI ara√ßlarƒ±', 'AI ile para kazanma', 'AI tehlikeleri', 'Midjourney', 'AI video', 'Claude', 'Gemini'],
                imagePrompt: 'futuristic AI technology, neural network, blue neon glow, modern tech'
            },
            bilim: {
                name: 'Bilim', color: '#6c5ce7',
                topics: ['uzay ke≈üifleri', 'beyin', 'kuantum', 'evrim', 'Mars', 'kara delikler', 'DNA'],
                imagePrompt: 'science discovery, space universe, laboratory, cosmic aesthetic'
            },
            fitness: {
                name: 'Fitness', color: '#00b894',
                topics: ['karƒ±n kasƒ±', 'kilo verme', 'kas yapma', 'ev egzersizi', 'protein', 'diyet', 'bacak'],
                imagePrompt: 'fitness workout, athletic training, modern gym, strong body'
            },
            finans: {
                name: 'Finans', color: '#fdcb6e',
                topics: ['tasarruf', 'yatƒ±rƒ±m', 'kripto', 'pasif gelir', 'borsa', 'altƒ±n', 'b√ºt√ße'],
                imagePrompt: 'financial success, money growth, dark luxury, gold accents'
            },
            yemek: {
                name: 'Yemek', color: '#e17055',
                topics: ['pratik tarif', 'saƒülƒ±klƒ±', 'kahvaltƒ±', 'tatlƒ±', 'et pi≈üirme', 'sebze', 'makarna'],
                imagePrompt: 'gourmet food photography, delicious meal, kitchen art'
            },
            sanat: {
                name: 'Sanat', color: '#fd79a8',
                topics: ['dijital sanat', '√ßizim', 'renk teorisi', 'tasarƒ±m', 'fotoƒüraf√ßƒ±lƒ±k', 'ill√ºstrasyon'],
                imagePrompt: 'creative art design, abstract colorful painting, artistic'
            },
            gelisim: {
                name: 'Ki≈üisel Geli≈üim', color: '#00cec9',
                topics: ['sabah rutini', 'prokrastinasyon', '√∂zg√ºven', 'zaman y√∂netimi', 'motivasyon', 'odaklanma'],
                imagePrompt: 'personal growth mindset, calm power, success lifestyle'
            },
            gizlitarih: {
                name: 'Gizli Tarih', color: '#636e72',
                topics: ['antik medeniyetler', 'kayƒ±p ≈üehirler', 'piramitler', 'gizli topluluklar', 'eski teknolojiler'],
                imagePrompt: 'ancient ruins, lost civilizations, dark mystery, stone textures'
            }
        };

        async function callAI(prompt) {
            const res = await fetch(API, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: 'google/gemma-2-2b-it', messages: [{ role: 'user', content: prompt }], max_tokens: 800, temperature: 0.85 })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message || data.error);
            return data.choices?.[0]?.message?.content || '';
        }

        async function generateImage(prompt) {
            // Try multiple image APIs
            const models = [
                'black-forest-labs/FLUX.1-schnell',
                'stabilityai/stable-diffusion-3.5-large',
                'ByteDance/SDXL-Lightning'
            ];

            for (const model of models) {
                try {
                    const res = await fetch(`https://router.huggingface.co/hf-inference/models/${model}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ inputs: prompt + ', high quality, no text, no letters, professional' })
                    });
                    if (res.ok) {
                        return URL.createObjectURL(await res.blob());
                    }
                } catch (e) {
                    console.log(`${model} failed, trying next...`);
                }
            }
            return null;
        }

        function cleanForTTS(text) {
            return text
                .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/[\*\#\[\]\(\)\"\']/g, '')
                .replace(/G√∂z temasƒ±|SORU:|KONU:|YAPI:|FORMAT:|KURALLAR:/gi, '')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        }

        // ============ SPEECH (Web Speech API) ============
        function speakScript() {
            if (!currentScript) return;
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(currentScript);
            u.lang = 'tr-TR';
            u.rate = parseFloat(document.getElementById('speedRange').value);
            u.pitch = 1.0;

            // Try to find Turkish voice
            const voices = speechSynthesis.getVoices();
            const turkishVoice = voices.find(v => v.lang.includes('tr'));
            if (turkishVoice) u.voice = turkishVoice;

            speechSynthesis.speak(u);
        }

        function stopSpeech() { speechSynthesis.cancel(); }

        // ============ CANVAS DRAWING ============
        function createReelsImage(baseImageUrl, question, cat) {
            const canvas = document.getElementById('finalCanvas');
            const ctx = canvas.getContext('2d');
            drawGradientBg(ctx, canvas, cat.color);

            if (baseImageUrl) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    const aspectRatio = img.width / img.height;
                    let drawWidth = canvas.width - 40;
                    let drawHeight = drawWidth / aspectRatio;
                    if (drawHeight > 480) { drawHeight = 480; drawWidth = drawHeight * aspectRatio; }
                    const x = (canvas.width - drawWidth) / 2;
                    ctx.drawImage(img, x, 200, drawWidth, drawHeight);
                    addReelsOverlays(ctx, canvas, question, cat);
                };
                img.onerror = () => addReelsOverlays(ctx, canvas, question, cat);
                img.src = baseImageUrl;
            } else {
                addReelsOverlays(ctx, canvas, question, cat);
            }
        }

        function drawGradientBg(ctx, canvas, accentColor) {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0f0f1a');
            gradient.addColorStop(0.5, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function addReelsOverlays(ctx, canvas, question, cat) {
            // Category badge
            ctx.fillStyle = cat.color;
            roundRect(ctx, 20, 25, 180, 36, 18);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px Segoe UI';
            ctx.fillText('‚ùì ' + cat.name.toUpperCase(), 38, 50);

            // Question box
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            roundRect(ctx, 20, 75, canvas.width - 40, 110, 14);
            ctx.fill();
            ctx.strokeStyle = cat.color;
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 22px Segoe UI';
            ctx.textAlign = 'center';
            wrapText(ctx, question, canvas.width / 2, 115, canvas.width - 60, 28);
            ctx.textAlign = 'left';

            // CTA Box
            const ctaGradient = ctx.createLinearGradient(30, canvas.height - 160, canvas.width - 30, canvas.height - 90);
            ctaGradient.addColorStop(0, cat.color);
            ctaGradient.addColorStop(1, shadeColor(cat.color, -20));
            ctx.fillStyle = ctaGradient;
            roundRect(ctx, 30, canvas.height - 160, canvas.width - 60, 75, 14);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 20px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('üí° Cevap i√ßin a√ßƒ±klamayƒ± oku!', canvas.width / 2, canvas.height - 115);

            // Footer
            ctx.font = '15px Segoe UI';
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillText('üíæ Kaydet  ‚Ä¢  üëÜ Takip Et', canvas.width / 2, canvas.height - 35);
            ctx.textAlign = 'left';
        }

        // ============ VIDEO PREVIEW ============
        function createVideoPreview() {
            const canvas = document.getElementById('finalCanvas');
            const video = document.getElementById('videoPreview');
            const placeholder = document.getElementById('videoPlaceholder');

            // Create a simple video-like preview using the canvas
            placeholder.style.display = 'none';

            // Start TTS and show animation
            speakScript();

            // Show message that this is a preview
            alert('üé¨ Video √∂nizlemesi: G√∂rsel + Seslendirme beraber oynatƒ±lƒ±yor.\n\nGer√ßek video i√ßin CapCut veya InShot kullanabilirsin!');
        }

        // ============ CAROUSEL SLIDES ============
        async function createCarouselSlides(question, tips, cat) {
            carouselSlides = [];
            const container = document.getElementById('carouselPreview');
            container.innerHTML = '';

            const slideConfigs = [
                { type: 'cover', title: question },
                ...tips.slice(0, 5).map((tip, i) => ({ type: 'tip', num: i + 1, content: tip })),
                { type: 'cta' }
            ];

            for (let i = 0; i < slideConfigs.length; i++) {
                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = 1080;
                const ctx = canvas.getContext('2d');

                await drawCarouselSlide(ctx, canvas, slideConfigs[i], cat, i + 1, slideConfigs.length);

                carouselSlides.push(canvas);

                const wrapper = document.createElement('div');
                wrapper.className = 'carousel-slide';
                const preview = document.createElement('canvas');
                preview.width = 200;
                preview.height = 200;
                preview.getContext('2d').drawImage(canvas, 0, 0, 200, 200);
                preview.style.width = '100%';

                const label = document.createElement('div');
                label.className = 'carousel-slide-label';
                label.textContent = `Slide ${i + 1}`;

                wrapper.appendChild(preview);
                wrapper.appendChild(label);
                wrapper.onclick = () => downloadSlide(i);
                container.appendChild(wrapper);
            }
        }

        async function drawCarouselSlide(ctx, canvas, config, cat, num, total) {
            // Premium gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#0f0f1a');
            gradient.addColorStop(0.4, shadeColor(cat.color, -70));
            gradient.addColorStop(1, '#1a1a2e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Glassmorphism card
            ctx.fillStyle = 'rgba(255,255,255,0.05)';
            roundRect(ctx, 60, 60, canvas.width - 120, canvas.height - 120, 40);
            ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Page indicator
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '24px Segoe UI';
            ctx.textAlign = 'right';
            ctx.fillText(`${num}/${total}`, canvas.width - 80, 110);
            ctx.textAlign = 'left';

            if (config.type === 'cover') {
                // Cover slide
                ctx.fillStyle = cat.color;
                roundRect(ctx, 100, 200, 250, 50, 25);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 24px Segoe UI';
                ctx.fillText('‚ùì ' + cat.name.toUpperCase(), 130, 235);

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 52px Segoe UI';
                ctx.textAlign = 'center';
                wrapText(ctx, config.title, canvas.width / 2, 420, canvas.width - 200, 65);

                ctx.font = '28px Segoe UI';
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fillText('üëâ Kaydƒ±r ve √∂ƒüren', canvas.width / 2, canvas.height - 150);
                ctx.textAlign = 'left';

            } else if (config.type === 'tip') {
                // Tip slide
                const numCircleSize = 120;
                ctx.fillStyle = cat.color;
                ctx.beginPath();
                ctx.arc(canvas.width / 2, 250, numCircleSize / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 60px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText(config.num.toString(), canvas.width / 2, 270);

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 42px Segoe UI';
                wrapText(ctx, config.content, canvas.width / 2, 480, canvas.width - 180, 55);
                ctx.textAlign = 'left';

            } else if (config.type === 'cta') {
                // CTA slide
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 48px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText('Bu bilgi i≈üine yaradƒ±ysa...', canvas.width / 2, 280);

                const buttons = [
                    { emoji: 'üíæ', text: 'KAYDET', y: 420 },
                    { emoji: 'üì§', text: 'PAYLA≈û', y: 550 },
                    { emoji: 'üëÜ', text: 'TAKƒ∞P ET', y: 680 }
                ];

                buttons.forEach(btn => {
                    ctx.fillStyle = cat.color;
                    roundRect(ctx, 200, btn.y - 40, canvas.width - 400, 80, 20);
                    ctx.fill();
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 32px Segoe UI';
                    ctx.fillText(`${btn.emoji} ${btn.text}`, canvas.width / 2, btn.y + 10);
                });

                ctx.font = '26px Segoe UI';
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.fillText('Daha fazlasƒ± i√ßin ‚Üí @hesabiniz', canvas.width / 2, canvas.height - 120);
                ctx.textAlign = 'left';
            }
        }

        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, Math.min(255, (num >> 16) + amt));
            const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));
            const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
            return `#${(1 << 24 | R << 16 | G << 8 | B).toString(16).slice(1)}`;
        }

        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                    ctx.fillText(line.trim(), x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line.trim(), x, y);
        }

        function copyScript() { navigator.clipboard.writeText(currentScript); alert('‚úÖ Kopyalandƒ±!'); }
        function copyCaption() {
            const hashtags = document.getElementById('hashtagBox').textContent;
            navigator.clipboard.writeText(currentCaption + '\n\n' + hashtags);
            alert('‚úÖ Caption + Hashtag kopyalandƒ±!');
        }

        function downloadImage() {
            const canvas = document.getElementById('finalCanvas');
            const link = document.createElement('a');
            link.download = `viral_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function downloadSlide(index) {
            if (!carouselSlides[index]) return;
            const link = document.createElement('a');
            link.download = `slide_${index + 1}.png`;
            link.href = carouselSlides[index].toDataURL('image/png');
            link.click();
        }

        async function downloadAllSlides() {
            for (let i = 0; i < carouselSlides.length; i++) {
                downloadSlide(i);
                await sleep(500);
            }
        }

        async function runWorkflow() {
            if (!getToken()) { alert('‚ö†Ô∏è Token girin!'); toggleConfig(); return; }

            const btn = document.getElementById('startBtn');
            const cat = CATEGORIES[selectedCategory];
            const randomTopic = getRandomTopic(cat.topics);

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Olu≈üturuluyor...';
            document.getElementById('stepsPanel').style.display = 'block';
            document.getElementById('outputBox').style.display = 'none';
            ['s1', 's2', 's3', 's4'].forEach(id => document.getElementById(id).className = 'step');

            try {
                // STEP 1: Find viral question
                document.getElementById('s1').className = 'step active';
                const questionPrompt = `2025 yƒ±lƒ±nda ${cat.name} konusunda "${randomTopic}" hakkƒ±nda viral olabilecek Bƒ∞R soru √ºret.

KURALLAR:
- "2025" ge√ßsin
- Liste vaadi olsun (5 adƒ±m, 3 hata gibi)
- Durdurma etkisi olsun
- TEK soru yaz, a√ßƒ±klama YAZMA`;

                currentQuestion = await callAI(questionPrompt);
                currentQuestion = currentQuestion.replace(/[\*\#\"\']/g, '').trim();
                if (!currentQuestion.endsWith('?')) currentQuestion += '?';
                document.getElementById('s1').className = 'step done';
                await sleep(500);

                // STEP 2: Write voiceover
                document.getElementById('s2').className = 'step active';
                const voicePrompt = `A≈üaƒüƒ±daki soru i√ßin T√úRK√áE ve DOƒûAL ƒ∞NSAN KONU≈ûMASI gibi seslendirme metni yaz.

SORU: "${currentQuestion}"
KONU: ${cat.name}

KONU≈ûMA TARZI:
- Kamera kar≈üƒ±sƒ±nda anlatƒ±yormu≈ü gibi
- Robot, sunum dili YASAK
- Kƒ±sa c√ºmleler, duraklamalƒ±
- Akƒ±cƒ±, rahat ton

YAPI:
1. Soruyu doƒüal ≈üekilde sor
2. "Peki asƒ±l mesele ne?" benzeri ge√ßi≈ü
3. 2-3 kƒ±sa alt soru
4. "Cevaplar basit deƒüil. Ama doƒüru olanlar var."
5. "A√ßƒ±klamayƒ± oku. √á√ºnk√º ${cat.name.toLowerCase()}, yanlƒ±≈ü bilgiyi affetmez."

KURALLAR: Emoji YOK, madde YOK, sayƒ± YOK, sadece ses i√ßin`;

                currentScript = await callAI(voicePrompt);
                currentScript = cleanForTTS(currentScript);
                document.getElementById('s2').className = 'step done';
                await sleep(500);

                // STEP 3: Generate visuals
                document.getElementById('s3').className = 'step active';

                if (selectedFormat === 'reels') {
                    const imgUrl = await generateImage(cat.imagePrompt);
                    createReelsImage(imgUrl, currentQuestion, cat);
                    document.getElementById('reelsOutput').style.display = 'block';
                    document.getElementById('carouselOutput').style.display = 'none';
                    document.getElementById('videoPlaceholder').style.display = 'flex';
                } else {
                    // Generate tips for carousel
                    const tipsPrompt = `"${currentQuestion}" i√ßin 5 kƒ±sa ipucu yaz.
Her ipucu 1 c√ºmle olsun. Sadece ipu√ßlarƒ±nƒ± yaz, numara olmadan.`;
                    const tipsRaw = await callAI(tipsPrompt);
                    const tips = tipsRaw.split('\n').filter(t => t.trim().length > 10).slice(0, 5);
                    await createCarouselSlides(currentQuestion, tips, cat);
                    document.getElementById('reelsOutput').style.display = 'none';
                    document.getElementById('carouselOutput').style.display = 'block';
                }
                document.getElementById('s3').className = 'step done';
                await sleep(500);

                // STEP 4: Caption + Hashtags
                document.getElementById('s4').className = 'step active';
                const captionPrompt = `"${currentQuestion}" i√ßin Instagram A√áIKLAMASI yaz.

CEVABI ƒ∞√áERMELƒ∞!
FORMAT:
1. Kƒ±sa giri≈ü
2. 5 maddelik cevap (üëâ ile)
3. "üíæ Kaydetmeden ge√ßme!" ile bitir`;

                currentCaption = await callAI(captionPrompt);
                currentCaption = currentCaption.replace(/[\*\#\"]/g, '').trim();

                const hashtagPrompt = `"${currentQuestion}" i√ßin 10 T√ºrk√ße hashtag yaz.`;
                let hashtags = await callAI(hashtagPrompt);
                hashtags = hashtags.match(/#[\wƒ±ƒü√º≈ü√∂√ßƒ∞ƒû√ú≈û√ñ√á]+/g) || [];
                document.getElementById('s4').className = 'step done';

                // Display results
                document.getElementById('outputBox').style.display = 'block';
                document.getElementById('questionBox').innerHTML = '‚ùì <strong>' + currentQuestion + '</strong>';
                document.getElementById('scriptBox').textContent = currentScript;
                document.getElementById('captionBox').textContent = currentCaption;
                document.getElementById('hashtagBox').innerHTML = hashtags.slice(0, 10).map(h => `<span class="hashtag">${h}</span>`).join('');

            } catch (e) {
                alert('Hata: ' + e.message);
            }

            btn.disabled = false;
            btn.textContent = 'üîÑ YENƒ∞ ƒ∞√áERƒ∞K OLU≈ûTUR';
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    </script>
</body>

</html>
